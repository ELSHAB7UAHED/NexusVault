name: Build NexusVault Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Create requirements.txt if not exists
      run: |
        if [ ! -f requirements.txt ]; then
          echo "PyQt6>=6.5.0" > requirements.txt
          echo "fastapi>=0.104.0" >> requirements.txt
          echo "uvicorn[standard]>=0.24.0" >> requirements.txt
          echo "jinja2>=3.1.2" >> requirements.txt
          echo "qrcode[pil]>=7.4.2" >> requirements.txt
          echo "pillow>=10.0.0" >> requirements.txt
          echo "requests>=2.31.0" >> requirements.txt
        fi
    
    - name: Build with PyInstaller
      run: |
        # إنشاء spec file مخصص
        cat > NexusVault.spec << 'EOF'
        # -*- mode: python ; coding: utf-8 -*-
        
        a = Analysis(
            ['NexusVault.py'],
            pathex=[],
            binaries=[],
            datas=[
                ('NexusVault.png', '.'),
                ('nexusvault_config.json', '.'),
                ('uploads', 'uploads'),
                ('logs', 'logs')
            ],
            hiddenimports=[
                'PyQt6.QtCore',
                'PyQt6.QtGui',
                'PyQt6.QtWidgets',
                'PyQt6.QtWebEngineWidgets',
                'PyQt6.QtWebEngineCore',
                'jinja2',
                'fastapi',
                'uvicorn',
                'qrcode',
                'PIL'
            ],
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=None,
            noarchive=False,
        )
        
        # إضافة ملفات Qt الضرورية
        if sys.platform == 'win32':
            a.binaries += [
                ('Qt6WebEngineCore.dll', 'C:\\path\\to\\Qt6WebEngineCore.dll', 'BINARY'),
            ]
        
        pyz = PYZ(a.pure, a.zipped_data, cipher=None)
        
        exe = EXE(
            pyz,
            a.scripts,
            a.binaries,
            a.datas,
            [],
            name='NexusVault',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False,  # تغيير إلى True إذا أردت نافذة Console
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon='NexusVault.png' if os.path.exists('NexusVault.png') else None,
        )
        
        if sys.platform == 'darwin':
            coll = COLLECT(
                exe,
                a.binaries,
                a.datas,
                strip=False,
                upx=True,
                upx_exclude=[],
                name='NexusVault',
                icon='NexusVault.png' if os.path.exists('NexusVault.png') else None,
            )
        EOF
        
        # بناء الملف التنفيذي
        pyinstaller --clean --noconfirm NexusVault.spec
        
    - name: Create platform-specific package
      run: |
        mkdir -p dist/NexusVault_${{ matrix.os }}
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp dist/NexusVault.exe dist/NexusVault_${{ matrix.os }}/
          # إنشاء ملف README للويندوز
          cat > dist/NexusVault_${{ matrix.os }}/README.txt << 'EOF'
          NexusVault - Secure File Transfer Hub
          =====================================
          
          Developed by: Ahmed Noor Ahmed (Qena, Egypt)
          
          Features:
          - Secure file sharing
          - QR code generation
          - Batch ZIP downloads
          - Modern GUI interface
          
          Requirements:
          - Windows 10/11
          - .NET Framework 4.8 (usually pre-installed)
          
          Usage:
          Just run NexusVault.exe
          
          Default URL: http://localhost:8080
          EOF
          
          # ضغط للملفات
          cd dist
          7z a -tzip NexusVault_Windows.zip NexusVault_${{ matrix.os }}/*
          
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          cp dist/NexusVault dist/NexusVault_${{ matrix.os }}/
          chmod +x dist/NexusVault_${{ matrix.os }}/NexusVault
          
          # إنشاء AppImage (اختياري)
          cat > dist/NexusVault_${{ matrix.os }}/NexusVault.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=NexusVault
          Comment=Secure File Transfer Hub
          Exec=./NexusVault
          Icon=NexusVault.png
          Categories=Network;FileTransfer;
          EOF
          
          cd dist
          tar -czf NexusVault_Linux.tar.gz NexusVault_${{ matrix.os }}/
          
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          # إنشاء bundle للماك
          mkdir -p dist/NexusVault.app/Contents/MacOS
          mkdir -p dist/NexusVault.app/Contents/Resources
          
          cp dist/NexusVault dist/NexusVault.app/Contents/MacOS/
          cp NexusVault.png dist/NexusVault.app/Contents/Resources/ 2>/dev/null || true
          
          cat > dist/NexusVault.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>NexusVault</string>
              <key>CFBundleDisplayName</key>
              <string>NexusVault</string>
              <key>CFBundleIdentifier</key>
              <string>com.ahmednoor.nexusvault</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleExecutable</key>
              <string>NexusVault</string>
              <key>CFBundleIconFile</key>
              <string>NexusVault.png</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          cd dist
          hdiutil create -volname "NexusVault" -srcfolder NexusVault.app -ov -format UDZO NexusVault_Mac.dmg
          
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NexusVault-${{ matrix.os }}
        path: |
          dist/*.zip
          dist/*.tar.gz
          dist/*.dmg
          dist/NexusVault_${{ matrix.os }}/
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.zip
          dist/*.tar.gz
          dist/*.dmg
        body: |
          # NexusVault ${{ github.ref_name }}
          
          Secure, Modern, Cross-Platform File Nexus
          
          ## Features
          - File upload with SHA-256 deduplication
          - QR code sharing
          - Batch ZIP downloads
          - Modern PyQt6 GUI
          - Cross-platform support
          
          ## Developer
          Ahmed Noor Ahmed - Telecommunications Engineer, Qena, Egypt
